---
kind: Template
apiVersion: v1
metadata:
  annotations:
    description: Setup for GlusterFS persistent volume recycler
    version: '1.0.0'
  name: setup-recycler
labels:
  template: "gluster-recycler"
parameters:
- description: 'The name of the namespace being deployed into (sorry, templates cant look this up)'
  name: NAMESPACE
  required: true
- description: 'A semi-colon ";" separated list of glusterfs hosts that make up your glusterfs cluster (only one cluster supported).'
  name: GLUSTER_HOSTS
  required: true
- description: 'Interval in seconds between recycler runs (defaults to every 5 minutes)'
  name: INTERVAL
  required: false
  value: "300"
- description: 'Delay in seconds before a volume is recycled after it failed (defaults to no delay)'
  name: DELAY
  required: false
  value: "0"
- description: 'Enable extra logging for debugging (defaults to false)'
  name: DEBUG
  required: false
  value: "false"
- description: 'Timezone (TZ) of the container, see https://en.wikipedia.org/wiki/List_of_tz_database_time_zones for a list'
  name: TIMEZONE
  value: UTC
  required: true
- description: 'Name of image stream for recycler container'
  name: IMAGE_STREAM_NAME
  value: gluster-recycler
  required: true
objects:

- apiVersion: v1
  kind: ServiceAccount
  metadata:
    name: gluster-recycler

- kind: ClusterRole
  apiVersion: v1
  metadata:
    name: gluster-recycler
  rules:
  - verbs:
    - create
    - delete
    - get
    - list
    - replace
    - update
    - patch
    attributeRestrictions:
    apiGroups:
    resources:
    - persistentvolumes

- apiVersion: v1
  groupNames: null
  kind: ClusterRoleBinding
  metadata:
    name: gluster-recycler
  roleRef:
    name: gluster-recycler
  subjects:
  - kind: ServiceAccount
    name: gluster-recycler
    namespace: ${NAMESPACE}
  userNames:
  - system:serviceaccount:${NAMESPACE}:gluster-recycler

- apiVersion: v1
  kind: DeploymentConfig
  metadata:
    labels:
    name: gluster-recycler
  spec:
    replicas: 1
    revisionHistoryLimit: 2
    selector:
      name: gluster-recycler
    strategy:
      type: Recreate
    template:
      metadata:
        labels:
          name: gluster-recycler
        name: gluster-recycler
      spec:
        containers:
        - name: gluster-recycler
          image: gluster-recycler
          imagePullPolicy: Always
          env:
          - name: INTERVAL
            value: ${INTERVAL}
          - name: DELAY
            value: ${DELAY}
          - name: CLUSTER
            value: ${GLUSTER_HOSTS}
          - name: DEBUG
            value: ${DEBUG}
          - name: TZ
            value: ${TIMEZONE}
          args:
            - "bash"
            - "-c"
            - "/recycler.sh"
          securityContext:
            privileged: true
        restartPolicy: Always
        serviceAccountName: gluster-recycler
    triggers:
    - type: ConfigChange
    - type: ImageChange
      imageChangeParams:
        automatic: true
        from:
          kind: ImageStream
          name: ${IMAGE_STREAM_NAME}
        containerNames:
        - gluster-recycler
